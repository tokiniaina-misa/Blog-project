{% for comment in comments %}
    {% if comment.parent == parent %}
    <div class="mb-6 ml-{{ forloop.parentloop|default:0|add:0|add:0 }}">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xl">
                {{ comment.author.username|first|upper }}
            </div>
            <div class="flex-1">
                <div class="font-semibold text-gray-800">{{ comment.author.username }}</div>
                <div class="text-xs text-gray-500 mb-2">{{ comment.created_at|timesince }} ago</div>
                <div class="text-gray-700 mb-2">{{ comment.content|linebreaks }}</div>
                <div class="flex gap-4 mb-2">
                    <a href="#" class="text-blue-600 hover:underline font-medium reply-btn" data-comment-id="{{ comment.id }}">Reply</a>
                    {% if comment.replies.count > 0 %}
                        <a href="#" class="text-gray-500 hover:underline font-medium toggle-thread-btn" data-thread-id="{{ comment.id }}">Hide replies</a>
                    {% endif %}
                </div>
                <form id="reply-form-{{ comment.id }}" class="hidden mb-2" method="post" action="/post/{{ post.id }}/comment/">
                    {% csrf_token %}
                    <input type="hidden" name="parent" value="{{ comment.id }}">
                    <textarea name="content" rows="3" class="w-full px-4 py-2 border rounded focus:outline-none mb-2" placeholder="Add a comment..."></textarea>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded transition-all duration-200 hover:scale-105 hover:shadow-lg">Send</button>
                </form>
                {% if comment.replies.count > 0 %}
                <div id="thread-{{ comment.id }}" class="ml-8">
                    {% include 'blog/threaded_comments.html' with comments=comments parent=comment post=post user=user %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
{% empty %}
    {% if parent == None %}
        <p class="text-gray-500">No comments yet.</p>
    {% endif %}
{% endfor %}
